<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='一、前言 在日常开发中，测试阶段需要开发去手动打包，这样效率很低下，而且如果开发正在其他分支或者正在开发，打包也非常麻烦。所以在这个背景下，自动化打包平台的诞生显得尤为重要。
二、基础概念介绍 Jenkins Jenkins是一个开源软件项目，是基于Java开发的一种持续集成工具，用于监控持续重复的工作，旨在提供一个开放易用的软件平台，使软件项目可以进行持续集成
Gradle Gradle是一个基于Apache Ant和Apache Maven概念的项目自动化构建开源工具。它使用一种基于Groovy的特定领域语言(DSL)来声明项目设置，目前也增加了基于Kotlin语言的kotlin-based DSL，抛弃了基于XML的各种繁琐配置
Fastlane Fastlane是用Ruby语言编写的一套自动化工具集和框架，每一个工具实际都对应一个Ruby脚本，用来执行某一个特定的任务，而fastlane核心框架则允许使用者通过类似配置文件的形式，将不同的工具有机而灵活的结合在一起，从而形成一个个完整的自动化流程。
三、App自动化打包的搭建流程 第一步，搭建Jenkins，这个网上都有大量教程，我就不详细赘述了。
第二步，搭建Android、IOS开发环境，这里网上也有大量教程，不在赘述
第三步，书写Jenkins自动化打包脚本，Jenkins新建对应的任务
总体来说，搭建App自动化打包的步骤主要就这3步。主要介绍的就是第3步，这里用我们工程里的脚本来详细说明，每行命令的作用。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 pipeline { agent any parameters { string(name: &amp;#39;EMAIL&amp;#39;, defaultValue: &amp;#39;liang@xyz.'>
<title>App自动化打包平台的搭建与维护</title>

<link rel='canonical' href='https://rmondjone.github.io/posts/devops/app_ci/'>

<link rel="stylesheet" href="/scss/style.min.8191399262444ab68b72a18c97392f5349be20a1615d77445be51e974c144cff.css"><meta property='og:title' content='App自动化打包平台的搭建与维护'>
<meta property='og:description' content='一、前言 在日常开发中，测试阶段需要开发去手动打包，这样效率很低下，而且如果开发正在其他分支或者正在开发，打包也非常麻烦。所以在这个背景下，自动化打包平台的诞生显得尤为重要。
二、基础概念介绍 Jenkins Jenkins是一个开源软件项目，是基于Java开发的一种持续集成工具，用于监控持续重复的工作，旨在提供一个开放易用的软件平台，使软件项目可以进行持续集成
Gradle Gradle是一个基于Apache Ant和Apache Maven概念的项目自动化构建开源工具。它使用一种基于Groovy的特定领域语言(DSL)来声明项目设置，目前也增加了基于Kotlin语言的kotlin-based DSL，抛弃了基于XML的各种繁琐配置
Fastlane Fastlane是用Ruby语言编写的一套自动化工具集和框架，每一个工具实际都对应一个Ruby脚本，用来执行某一个特定的任务，而fastlane核心框架则允许使用者通过类似配置文件的形式，将不同的工具有机而灵活的结合在一起，从而形成一个个完整的自动化流程。
三、App自动化打包的搭建流程 第一步，搭建Jenkins，这个网上都有大量教程，我就不详细赘述了。
第二步，搭建Android、IOS开发环境，这里网上也有大量教程，不在赘述
第三步，书写Jenkins自动化打包脚本，Jenkins新建对应的任务
总体来说，搭建App自动化打包的步骤主要就这3步。主要介绍的就是第3步，这里用我们工程里的脚本来详细说明，每行命令的作用。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 pipeline { agent any parameters { string(name: &amp;#39;EMAIL&amp;#39;, defaultValue: &amp;#39;liang@xyz.'>
<meta property='og:url' content='https://rmondjone.github.io/posts/devops/app_ci/'>
<meta property='og:site_name' content='郭翰林的博客'>
<meta property='og:type' content='article'><meta property='article:section' content='Posts' /><meta property='article:tag' content='Devops' /><meta property='article:published_time' content='2023-04-07T10:25:32&#43;08:00'/><meta property='article:modified_time' content='2023-04-07T10:25:32&#43;08:00'/>
<meta name="twitter:title" content="App自动化打包平台的搭建与维护">
<meta name="twitter:description" content="一、前言 在日常开发中，测试阶段需要开发去手动打包，这样效率很低下，而且如果开发正在其他分支或者正在开发，打包也非常麻烦。所以在这个背景下，自动化打包平台的诞生显得尤为重要。
二、基础概念介绍 Jenkins Jenkins是一个开源软件项目，是基于Java开发的一种持续集成工具，用于监控持续重复的工作，旨在提供一个开放易用的软件平台，使软件项目可以进行持续集成
Gradle Gradle是一个基于Apache Ant和Apache Maven概念的项目自动化构建开源工具。它使用一种基于Groovy的特定领域语言(DSL)来声明项目设置，目前也增加了基于Kotlin语言的kotlin-based DSL，抛弃了基于XML的各种繁琐配置
Fastlane Fastlane是用Ruby语言编写的一套自动化工具集和框架，每一个工具实际都对应一个Ruby脚本，用来执行某一个特定的任务，而fastlane核心框架则允许使用者通过类似配置文件的形式，将不同的工具有机而灵活的结合在一起，从而形成一个个完整的自动化流程。
三、App自动化打包的搭建流程 第一步，搭建Jenkins，这个网上都有大量教程，我就不详细赘述了。
第二步，搭建Android、IOS开发环境，这里网上也有大量教程，不在赘述
第三步，书写Jenkins自动化打包脚本，Jenkins新建对应的任务
总体来说，搭建App自动化打包的步骤主要就这3步。主要介绍的就是第3步，这里用我们工程里的脚本来详细说明，每行命令的作用。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 pipeline { agent any parameters { string(name: &amp;#39;EMAIL&amp;#39;, defaultValue: &amp;#39;liang@xyz.">
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu5046a004738fe6196f796d96e16bab8b_7661_300x0_resize_q75_box.jpeg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">🍥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">郭翰林的博客</a></h1>
            <h2 class="site-description">移动端开发工程师</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/RmondJone/'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com/RmondJone'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>首页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>文章</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E%E6%88%91/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>关于我</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>暗色模式</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li>
      <ol>
        <li><a href="#一前言">一、前言</a></li>
        <li><a href="#二基础概念介绍">二、基础概念介绍</a></li>
        <li><a href="#三app自动化打包的搭建流程">三、App自动化打包的搭建流程</a></li>
        <li><a href="#四androidios打包脚本详解">四、Android、IOS打包脚本详解</a></li>
        <li><a href="#五jenkins里的任务配置">五、Jenkins里的任务配置</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/devops/" style="background-color: #2a9d8f; color: #fff;">
                DevOps
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/posts/devops/app_ci/">App自动化打包平台的搭建与维护</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Apr 07, 2023</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 8 分钟
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h3 id="一前言">一、前言</h3>
<p>在日常开发中，测试阶段需要开发去手动打包，这样效率很低下，而且如果开发正在其他分支或者正在开发，打包也非常麻烦。所以在这个背景下，自动化打包平台的诞生显得尤为重要。</p>
<h3 id="二基础概念介绍">二、基础概念介绍</h3>
<ul>
<li>
<p>Jenkins
Jenkins是一个开源软件项目，是基于Java开发的一种持续集成工具，用于监控持续重复的工作，旨在提供一个开放易用的软件平台，使软件项目可以进行持续集成</p>
</li>
<li>
<p>Gradle
Gradle是一个基于Apache Ant和Apache Maven概念的项目自动化构建开源工具。它使用一种基于Groovy的特定领域语言(DSL)来声明项目设置，目前也增加了基于Kotlin语言的kotlin-based DSL，抛弃了基于XML的各种繁琐配置</p>
</li>
<li>
<p>Fastlane
Fastlane是用Ruby语言编写的一套自动化工具集和框架，每一个工具实际都对应一个Ruby脚本，用来执行某一个特定的任务，而fastlane核心框架则允许使用者通过类似配置文件的形式，将不同的工具有机而灵活的结合在一起，从而形成一个个完整的自动化流程。</p>
</li>
</ul>
<h3 id="三app自动化打包的搭建流程">三、App自动化打包的搭建流程</h3>
<ul>
<li>
<p>第一步，搭建Jenkins，这个网上都有大量教程，我就不详细赘述了。</p>
</li>
<li>
<p>第二步，搭建Android、IOS开发环境，这里网上也有大量教程，不在赘述</p>
</li>
<li>
<p>第三步，书写Jenkins自动化打包脚本，Jenkins新建对应的任务</p>
</li>
</ul>
<p>总体来说，搭建App自动化打包的步骤主要就这3步。主要介绍的就是第3步，这里用我们工程里的脚本来详细说明，每行命令的作用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pipeline {
</span></span><span class="line"><span class="cl">    agent any
</span></span><span class="line"><span class="cl">    parameters {
</span></span><span class="line"><span class="cl">        string(name: &#39;EMAIL&#39;, defaultValue: &#39;liang@xyz.cn&#39;, description: &#39;编译任务结束时通知的邮箱&#39;)
</span></span><span class="line"><span class="cl">        string(name: &#39;PGYER_DESCRIPTION&#39;, defaultValue: &#39;&#39;, description: &#39;此次打包备注(可选,默认显示分支和此次任务Build ID)&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        choice(choices: [&#39;ANDROID&#39;,&#39;IOS&#39;], description: &#39;编译哪个平台?&#39;, name: &#39;BUILD_PLATFORM&#39;)
</span></span><span class="line"><span class="cl">        choice(choices: [&#39;Debug&#39;, &#39;Preview&#39;, &#39;Release&#39;], description: &#39;编译什么版本?(Android P版请选择Preview不要用Release!!!)&#39;, name: &#39;BUILD_TYPE&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        string(name: &#39;FILE_NAME&#39;, defaultValue: &#39;xyz_app&#39;, description: &#39;输出安装包的文件名(尽量英文),不能为空&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        string(name: &#39;API_HOST&#39;, defaultValue: &#39;&#39;, description: &#39;接口地址,不改就留空&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        string(name: &#39;BUILD_VERSION_NAME&#39;, defaultValue: &#39;&#39;, description: &#39;版本号(格式:x.y.z),不改就留空&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        string(name: &#39;PGYER_API_KEY&#39;, defaultValue: &#39;43aad9a3e16b23382b6350e05546db49&#39;, description: &#39;蒲公英分发api key,不懂请保持默认&#39;)
</span></span><span class="line"><span class="cl">        string(name: &#39;PGYER_USER_KEY&#39;, defaultValue: &#39;35f87a2f64bde6cfed825ae188e2c1f0&#39;, description: &#39;蒲公英分发user key,不懂请保持默认&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        booleanParam(name:&#39;UPDATE_POD&#39;,defaultValue:false,description:&#39;是否更新Pod库?&#39;)
</span></span><span class="line"><span class="cl">        choice(name:&#39;POD_REPO&#39;,choices:[&#34;xyz-appdev-spec&#34;,&#34;artsy&#34;,&#34;master&#34;],description:&#39;具体更新哪一个Pod库&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        booleanParam(name:&#39;GRADLE_OFFLINE&#39;,defaultValue:true,description:&#39;是否采用Gradle离线模式?&#39;)
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    environment {
</span></span><span class="line"><span class="cl">        LANG = &#34;en_US.UTF-8&#34;
</span></span><span class="line"><span class="cl">        //sentry cli cdn 链接
</span></span><span class="line"><span class="cl">        SENTRYCLI_CDNURL = &#39;http://cdn.npm.taobao.org/dist/sentry-cli&#39;
</span></span><span class="line"><span class="cl">		    //蒲公英 ipa路径
</span></span><span class="line"><span class="cl">		    PGYER_IPA = &#34;./build/XYZ_iOS.ipa&#34;
</span></span><span class="line"><span class="cl">		    //蒲公英 上传描述
</span></span><span class="line"><span class="cl">		    PGYER_UPDATE_DESCRIPTION = &#34;Jenkins任务号: 【${BUILD_DISPLAY_NAME}】 本次编译的分支:【${BRANCH_NAME}】  编译类型:【${params.BUILD_TYPE}】  额外备注:【${params.PGYER_DESCRIPTION}】&#34;
</span></span><span class="line"><span class="cl">        //ios 输出目录
</span></span><span class="line"><span class="cl">        GYM_OUTPUT_DIRECTORY = &#34;./build&#34;
</span></span><span class="line"><span class="cl">		    //testFlight ipa 路径
</span></span><span class="line"><span class="cl">		    PILOT_IPA = &#34;${PGYER_IPA}&#34;
</span></span><span class="line"><span class="cl">		    //testFlight 升级描述
</span></span><span class="line"><span class="cl">		    PILOT_BETA_APP_DESCRIPTION = &#34;${PGYER_UPDATE_DESCRIPTION}&#34;
</span></span><span class="line"><span class="cl">		    FL_VERSION_NUMBER_VERSION_NUMBER = &#34;${params.BUILD_VERSION_NAME}&#34;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    tools {
</span></span><span class="line"><span class="cl">        nodejs &#34;nodejs&#34;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    stages {
</span></span><span class="line"><span class="cl">        stage(&#39;Prepare&#39;) {
</span></span><span class="line"><span class="cl">            steps {
</span></span><span class="line"><span class="cl">                sh &#34;mkdir build &amp;&amp; printenv &amp;&amp; printenv &gt; build/env.txt&#34;
</span></span><span class="line"><span class="cl">                script {
</span></span><span class="line"><span class="cl">                    if(&#34;${params.BUILD_TYPE}&#34; !=&#34;Debug&#34;){
</span></span><span class="line"><span class="cl">                      sh &#39;&#39;&#39;
</span></span><span class="line"><span class="cl">                          sed -i &#34;s#sensorsAnalytics.disablePlugin=true#sensorsAnalytics.disablePlugin=false#g&#34; android/gradle.properties
</span></span><span class="line"><span class="cl">                      &#39;&#39;&#39;
</span></span><span class="line"><span class="cl">                      sh &#34;cat android/gradle.properties&#34;
</span></span><span class="line"><span class="cl">                    }
</span></span><span class="line"><span class="cl">                    sh &#39;&#39;&#39;
</span></span><span class="line"><span class="cl">                        sed -i &#34;s#{...getPersistenceFunctions(pageName)}##g&#34; app/entry/App.js
</span></span><span class="line"><span class="cl">                    &#39;&#39;&#39;
</span></span><span class="line"><span class="cl">                    sh &#34;cat app/entry/App.js&#34;
</span></span><span class="line"><span class="cl">                    if(&#34;${params.BUILD_VERSION_NAME}&#34; != &#34;&#34;){
</span></span><span class="line"><span class="cl">                      sh &#39;&#39;&#39;
</span></span><span class="line"><span class="cl">                         sed -i &#34;s/\\(VersionName=\\)\\([0-9]\\{1,\\}\\.[0-9]\\{1,\\}\\.[0-9]\\{1,\\}\\)/\\1${BUILD_VERSION_NAME}/g&#34; android/gradle.properties
</span></span><span class="line"><span class="cl">                      &#39;&#39;&#39;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                      sh &#34;cat android/gradle.properties&#34;
</span></span><span class="line"><span class="cl">                      sh &#34;cd ios &amp;&amp; fastlane build_version&#34;
</span></span><span class="line"><span class="cl">                    }
</span></span><span class="line"><span class="cl">                    if(&#34;${params.API_HOST}&#34; != &#34;&#34;){
</span></span><span class="line"><span class="cl">                      sh &#39;&#39;&#39;
</span></span><span class="line"><span class="cl">                         sed -i &#34;s#https://app\\.xyz\\.cn#${API_HOST}#g&#34; android/app/src/main/java/com/focustech/xyz/network/configuration/Host.java
</span></span><span class="line"><span class="cl">                      &#39;&#39;&#39;
</span></span><span class="line"><span class="cl">                      sh &#34;cat android/app/src/main/java/com/focustech/xyz/network/configuration/Host.java&#34;
</span></span><span class="line"><span class="cl">                      sh &#39;&#39;&#39;
</span></span><span class="line"><span class="cl">                         sed -i &#34;s#https://app\\.xyz\\.cn#${API_HOST}#g&#34; ios/XYZ_iOS/Resources/Plists/NetEnvironment.json
</span></span><span class="line"><span class="cl">                      &#39;&#39;&#39;
</span></span><span class="line"><span class="cl">                      sh &#34;cat ios/XYZ_iOS/Resources/Plists/NetEnvironment.json&#34;
</span></span><span class="line"><span class="cl">                    }
</span></span><span class="line"><span class="cl">                    if(params.UPDATE_POD &amp;&amp; &#34;${params.BUILD_PLATFORM}&#34;==&#39;IOS&#39;){
</span></span><span class="line"><span class="cl">                       sh &#34;cd ios &amp;&amp; pod repo update ${params.POD_REPO}&#34;
</span></span><span class="line"><span class="cl">                    }
</span></span><span class="line"><span class="cl">				        }
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">        stage(&#39;Build&#39;) {
</span></span><span class="line"><span class="cl">            when { expression { return !params.UPDATE_POD } }
</span></span><span class="line"><span class="cl">            steps {
</span></span><span class="line"><span class="cl">                script {
</span></span><span class="line"><span class="cl">                    sh &#39;npm install&#39;
</span></span><span class="line"><span class="cl">                    if (&#34;${params.BUILD_PLATFORM}&#34;  == &#39;ANDROID&#39;) {
</span></span><span class="line"><span class="cl">                        if(params.GRADLE_OFFLINE){
</span></span><span class="line"><span class="cl">                            if (&#34;${params.BUILD_TYPE}&#34;  == &#34;Preview&#34;){
</span></span><span class="line"><span class="cl">                              sh &#34;cd android &amp;&amp; bash gradlew --build-cache --offline assembleRelease&#34;
</span></span><span class="line"><span class="cl">                            }else if(&#34;${params.BUILD_TYPE}&#34;  == &#34;Release&#34;){
</span></span><span class="line"><span class="cl">                              sh &#34;cd android &amp;&amp; bash gradlew --build-cache --offline buildReinforceRelease&#34;
</span></span><span class="line"><span class="cl">                            }else {
</span></span><span class="line"><span class="cl">                              sh &#34;cd android &amp;&amp; bash gradlew --build-cache --offline assemble${params.BUILD_TYPE}&#34;
</span></span><span class="line"><span class="cl">                            }
</span></span><span class="line"><span class="cl">                        }else{
</span></span><span class="line"><span class="cl">                            if (&#34;${params.BUILD_TYPE}&#34;  == &#34;Preview&#34;){
</span></span><span class="line"><span class="cl">                              sh &#34;cd android &amp;&amp; bash gradlew --build-cache assembleRelease&#34;
</span></span><span class="line"><span class="cl">                            }else if(&#34;${params.BUILD_TYPE}&#34;  == &#34;Release&#34;){
</span></span><span class="line"><span class="cl">                              sh &#34;cd android &amp;&amp; bash gradlew --build-cache buildReinforceRelease&#34;
</span></span><span class="line"><span class="cl">                            }else {
</span></span><span class="line"><span class="cl">                              sh &#34;cd android &amp;&amp; bash gradlew --build-cache assemble${params.BUILD_TYPE}&#34;
</span></span><span class="line"><span class="cl">                            }
</span></span><span class="line"><span class="cl">                        }
</span></span><span class="line"><span class="cl">                    } else if (&#34;${params.BUILD_PLATFORM}&#34;  == &#39;IOS&#39;){
</span></span><span class="line"><span class="cl">                        sh &#39;cd ios &amp;&amp; pod install --verbose&#39;
</span></span><span class="line"><span class="cl">                        if(&#34;${params.BUILD_TYPE}&#34;  == &#39;Debug&#39;){
</span></span><span class="line"><span class="cl">                          sh &#39;cd ios &amp;&amp; fastlane build&#39;
</span></span><span class="line"><span class="cl">                        } else{
</span></span><span class="line"><span class="cl">                          sh &#39;cd ios &amp;&amp; fastlane build_ts&#39;
</span></span><span class="line"><span class="cl">                        }
</span></span><span class="line"><span class="cl">                    }
</span></span><span class="line"><span class="cl">                }
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">        stage(&#39;Deploy&#39;) {
</span></span><span class="line"><span class="cl">            when { expression { return !params.UPDATE_POD } }
</span></span><span class="line"><span class="cl">            steps {
</span></span><span class="line"><span class="cl">                script {
</span></span><span class="line"><span class="cl">                    archiveArtifacts artifacts: &#39;build/env.txt&#39;
</span></span><span class="line"><span class="cl">                    if (&#34;${params.BUILD_PLATFORM}&#34;  == &#39;ANDROID&#39;) {
</span></span><span class="line"><span class="cl">                        if(&#34;${params.BUILD_TYPE}&#34; == &#39;Release&#39;){
</span></span><span class="line"><span class="cl">                            sh &#34;mv android/app/build/outputs/apk/release/*.apk build/${FILE_NAME}-${BUILD_TYPE}.apk&#34;
</span></span><span class="line"><span class="cl">                            sh &#34;zip -r android/app/build/outputs/apk/release/${FILE_NAME}.zip android/app/build/outputs/apk/release/channels/&#34;
</span></span><span class="line"><span class="cl">                            sh &#34;mv android/app/build/outputs/apk/release/${FILE_NAME}.zip build/&#34;
</span></span><span class="line"><span class="cl">                            archiveArtifacts artifacts: &#34;build/*.apk&#34;
</span></span><span class="line"><span class="cl">                            archiveArtifacts artifacts: &#34;build/*.zip&#34;
</span></span><span class="line"><span class="cl">                        }else if(&#34;${params.BUILD_TYPE}&#34; == &#39;Debug&#39;) {
</span></span><span class="line"><span class="cl">                            sh &#34;mv android/app/build/outputs/apk/debug/*.apk build/${FILE_NAME}-${BUILD_TYPE}.apk&#34;
</span></span><span class="line"><span class="cl">                            archiveArtifacts artifacts: &#34;build/${FILE_NAME}-${BUILD_TYPE}.apk&#34;
</span></span><span class="line"><span class="cl">                        }else if(&#34;${params.BUILD_TYPE}&#34; == &#39;Preview&#39;) {
</span></span><span class="line"><span class="cl">                            sh &#34;mv android/app/build/outputs/apk/release/*.apk build/${FILE_NAME}-${BUILD_TYPE}.apk&#34;
</span></span><span class="line"><span class="cl">                            archiveArtifacts artifacts: &#34;build/${FILE_NAME}-${BUILD_TYPE}.apk&#34;
</span></span><span class="line"><span class="cl">                        }
</span></span><span class="line"><span class="cl">                        sh &#39;&#39;&#39;
</span></span><span class="line"><span class="cl">                            curl -F &#34;file=@build/${FILE_NAME}-${BUILD_TYPE}.apk&#34; -F &#34;userKey=${PGYER_USER_KEY}&#34; -F &#34;_api_key=${PGYER_API_KEY}&#34; -F &#34;buildInstallType=2&#34; -F &#34;buildPassword=123456&#34; -F &#34;buildUpdateDescription=${PGYER_UPDATE_DESCRIPTION}&#34; http://www.pgyer.com/apiv2/app/upload
</span></span><span class="line"><span class="cl">                        &#39;&#39;&#39;
</span></span><span class="line"><span class="cl">                    } else if (&#34;${params.BUILD_PLATFORM}&#34;  == &#39;IOS&#39;){
</span></span><span class="line"><span class="cl">                        archiveArtifacts artifacts: &#34;ios/build/*.ipa&#34;
</span></span><span class="line"><span class="cl">                        archiveArtifacts artifacts: &#34;ios/build/*.app.dSYM.zip&#34;
</span></span><span class="line"><span class="cl">                        sh &#34;mv ios/build/*.ipa build/${FILE_NAME}-${BUILD_TYPE}.ipa&#34;
</span></span><span class="line"><span class="cl">                        sh &#39;&#39;&#39;
</span></span><span class="line"><span class="cl">                           curl -F &#34;file=@build/${FILE_NAME}-${BUILD_TYPE}.ipa&#34; -F &#34;userKey=${PGYER_USER_KEY}&#34; -F &#34;_api_key=${PGYER_API_KEY}&#34; -F &#34;buildInstallType=2&#34; -F &#34;buildPassword=123456&#34; -F &#34;buildUpdateDescription=${PGYER_UPDATE_DESCRIPTION}&#34; http://www.pgyer.com/apiv2/app/upload
</span></span><span class="line"><span class="cl">                       &#39;&#39;&#39;
</span></span><span class="line"><span class="cl">                    }
</span></span><span class="line"><span class="cl">                }
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    post {
</span></span><span class="line"><span class="cl">        failure {
</span></span><span class="line"><span class="cl">            emailext attachLog: true, attachmentsPattern: &#39;build/**&#39;, body: &#34;jenkins任务失败!  ${PGYER_UPDATE_DESCRIPTION}  详情请点击:${BUILD_URL} 或直接从附件下载编译log自行查看!&#34;, compressLog: true, replyTo: &#39;&#39;, subject: &#39;jenkins任务失败,请排查问题&#39;, to: &#39;${EMAIL}&#39;
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">        aborted {
</span></span><span class="line"><span class="cl">            emailext attachLog: true, attachmentsPattern: &#39;build/**&#39;, body: &#34;jenkins任务中止!  ${PGYER_UPDATE_DESCRIPTION}  详情请点击:${BUILD_URL}&#34;, compressLog: true, replyTo: &#39;&#39;, subject: &#39;jenkins任务已中止&#39;, to: &#39;${EMAIL}&#39;
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">        success {
</span></span><span class="line"><span class="cl">            script {
</span></span><span class="line"><span class="cl">              if(!params.UPDATE_POD){
</span></span><span class="line"><span class="cl">                if (&#34;${params.BUILD_PLATFORM}&#34;  == &#39;ANDROID&#39;) {
</span></span><span class="line"><span class="cl">                  def packPath = &#34;build/${FILE_NAME}-${BUILD_TYPE}.apk&#34;
</span></span><span class="line"><span class="cl">                  echo &#34;packPath:${packPath}&#34;
</span></span><span class="line"><span class="cl">                  def packInfo = &#34;&#34;&#34;${sh(returnStdout: true, script: &#34;du -s ${packPath}&#34;)}&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">                  def packSize = packInfo.substring(0, packInfo.indexOf(&#39;	&#39;))
</span></span><span class="line"><span class="cl">                  echo &#34;packSize:${packSize}&#34;
</span></span><span class="line"><span class="cl">                  def packSizeMb = packSize.toInteger() / 2 / 1000
</span></span><span class="line"><span class="cl">                  def packSizeMbStr = &#34;&#34; + packSizeMb
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                  if(&#34;${params.BUILD_TYPE}&#34; == &#39;Preview&#39;){
</span></span><span class="line"><span class="cl">                    if(packSizeMb &gt; 40){
</span></span><span class="line"><span class="cl">                      emailext body: &#34;任务${BUILD_DISPLAY_NAME}安卓Preview包大小已经超过40Mb，现已达到${packSizeMbStr}Mb！&#34;, compressLog: true, replyTo: &#39;&#39;, subject: &#39;任务${BUILD_DISPLAY_NAME}安卓Preview包大小已经超过40Mb！&#39;, to: &#39;zhangwenxin@xyz.cn;guohanlin@xyz.cn;jinwenwu@xyz.cn;jinjianxin@xyz.cn&#39;
</span></span><span class="line"><span class="cl">                    }
</span></span><span class="line"><span class="cl">                  }
</span></span><span class="line"><span class="cl">                }else if (&#34;${params.BUILD_PLATFORM}&#34;  == &#39;IOS&#39;){
</span></span><span class="line"><span class="cl">                  def packPath = &#34;build/${FILE_NAME}-${BUILD_TYPE}.ipa&#34;
</span></span><span class="line"><span class="cl">                  echo &#34;packPath:${packPath}&#34;
</span></span><span class="line"><span class="cl">                  def packInfo = &#34;&#34;&#34;${sh(returnStdout: true, script: &#34;du -s ${packPath}&#34;)}&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">                  def packSize = packInfo.substring(0, packInfo.indexOf(&#39;	&#39;))
</span></span><span class="line"><span class="cl">                  echo &#34;packSize:${packSize}&#34;
</span></span><span class="line"><span class="cl">                  def packSizeMb = packSize.toInteger() / 2 / 1000
</span></span><span class="line"><span class="cl">                  def packSizeMbStr = &#34;&#34; + packSizeMb
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                  if(&#34;${params.BUILD_TYPE}&#34; == &#39;Preview&#39;){
</span></span><span class="line"><span class="cl">                    if(packSizeMb &gt; 40){
</span></span><span class="line"><span class="cl">                      emailext body: &#34;任务${BUILD_DISPLAY_NAME}苹果Preview包大小已经超过40Mb，现已达到${packSizeMbStr}Mb！&#34;, compressLog: true, replyTo: &#39;&#39;, subject: &#39;任务${BUILD_DISPLAY_NAME}苹果Preview包大小已经超过40Mb！&#39;, to: &#39;zhangwenxin@xyz.cn;guohanlin@xyz.cn;jinwenwu@xyz.cn;jinjianxin@xyz.cn&#39;
</span></span><span class="line"><span class="cl">                    }
</span></span><span class="line"><span class="cl">                  }
</span></span><span class="line"><span class="cl">                }
</span></span><span class="line"><span class="cl">              }
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">            script {
</span></span><span class="line"><span class="cl">               if(!params.UPDATE_POD){
</span></span><span class="line"><span class="cl">                  if(&#34;${params.BUILD_PLATFORM}&#34;==&#34;IOS&#34;){
</span></span><span class="line"><span class="cl">                    emailext body: &#34;jenkins任务成功! ${PGYER_UPDATE_DESCRIPTION} 详情请点击:${BUILD_URL} 或直接通过蒲公英下载! iOS下载链接 http://www.pgyer.com/xyz_ios&#34;, compressLog: true, replyTo: &#39;&#39;, subject: &#39;jenkins任务成功,请下载安装&#39;, to: &#39;${EMAIL}&#39;
</span></span><span class="line"><span class="cl">                  } else{
</span></span><span class="line"><span class="cl">                    emailext body: &#34;jenkins任务成功! ${PGYER_UPDATE_DESCRIPTION} 详情请点击:${BUILD_URL} 或直接通过蒲公英下载! Android下载链接 http://www.pgyer.com/xyz_android&#34;, compressLog: true, replyTo: &#39;&#39;, subject: &#39;jenkins任务成功,请下载安装&#39;, to: &#39;${EMAIL}&#39;
</span></span><span class="line"><span class="cl">                  }
</span></span><span class="line"><span class="cl">               }
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>首先我们来大致说下这个文件的大概意思，网上也有教程不明白的，可以再上网多找找资料。</p>
<p>第一大块<strong>parameters</strong>，这里面主要定义了一些任务的参数，例如我要打哪个平台的包啊、版本号啊、邮件通知啊这些。</p>
<p>第二大块<strong>environment</strong>，这里面主要定义了一些任务执行的环境以及预定义的一些全局的环境变量</p>
<p>第三大块<strong>stages</strong>，这里是比较重要的一块内容，这里主要定义了一些任务的阶段性任务，以及这个阶段性任务执行哪些脚本。</p>
<p>就好像上面的脚本，我把整个大任务分为了3个子任务：</p>
<ul>
<li>第一个子任务<strong>stage(&lsquo;Prepare&rsquo;）</strong>，主要定义了一些我要打包前需要做的一些事情，例如执行npm、替换工程中部分代码等等。</li>
<li>第二个子任务<strong>stage(&lsquo;Build&rsquo;)</strong>，主要就是执行真正的打包流程，例如Android走了Gradle脚本去执行打包，IOS走了FastLane去执行打包。</li>
<li>第三个子任务<strong>stage(&lsquo;Deploy&rsquo;)</strong>，主要执行打包完之后的一些操作，例如打出的包的归档操作、包大小检测、上传蒲公英操作、上传蒲公英之后邮件通知操作</li>
</ul>
<h3 id="四androidios打包脚本详解">四、Android、IOS打包脚本详解</h3>
<p>我们先来看Android，这里需要你有一定的Gradle基础，可以自己写简单的Gradle任务。从上面的Jenkins脚本，我们可以看到Android在打包的时候，区分了编译版本，debug和preview的直接调用Android自带的打包脚本assembleDebug、assembleRelease，Release版本也就是发布版本，这里我们做了自定义Gradle脚本<strong>buildReinforceRelease</strong>，为什么我们要自定义，因为通常我们上线发布的时候都需要加固APK并且做多渠道操作。如果每次都去手动用工具操作的话，这个是个很蛋疼的活。下面我们来看看这个脚本里有什么。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ext {
</span></span><span class="line"><span class="cl">    //加固插件路径
</span></span><span class="line"><span class="cl">    reinforce_plugin_path = &#34;${project.rootDir}/reinforce&#34;
</span></span><span class="line"><span class="cl">	//360加固账号
</span></span><span class="line"><span class="cl">    reinforce_plugin_name = &#39;xxxxxxxx&#39;
</span></span><span class="line"><span class="cl">    reinforce_plugin_passward = &#39;xxxxxxx&#39;
</span></span><span class="line"><span class="cl">    //签名信息
</span></span><span class="line"><span class="cl">    key_store_path = &#34;${project.rootDir}/app/xyz.keystore&#34;
</span></span><span class="line"><span class="cl">    key_store_passward = &#39;xxxxxxxxx&#39;
</span></span><span class="line"><span class="cl">    alias = &#39;xxxx&#39;
</span></span><span class="line"><span class="cl">    alias_passward = &#39;xxxxxxxxxx&#39;
</span></span><span class="line"><span class="cl">    //Release Apk输出路劲
</span></span><span class="line"><span class="cl">    release_apk_path = &#34;${project.buildDir}/outputs/apk/release/app-release.apk&#34;
</span></span><span class="line"><span class="cl">    //渠道配置文件
</span></span><span class="line"><span class="cl">    chanel_config_path = &#34;${reinforce_plugin_path}/channel.txt&#34;
</span></span><span class="line"><span class="cl">    //渠道Apk输出路径
</span></span><span class="line"><span class="cl">    channel_apks_path = &#34;${project.buildDir}/outputs/apk/release/channels/&#34;
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/**
</span></span><span class="line"><span class="cl"> * 注释：编译加固渠道包
</span></span><span class="line"><span class="cl"> * 时间：2019/1/2 0002 14:01
</span></span><span class="line"><span class="cl"> * 作者：郭翰林
</span></span><span class="line"><span class="cl"> */
</span></span><span class="line"><span class="cl">task buildReinforceRelease() {
</span></span><span class="line"><span class="cl">    group &#39;360reinforce&#39;
</span></span><span class="line"><span class="cl">    dependsOn(&#39;assembleRelease&#39;)
</span></span><span class="line"><span class="cl">    doLast {
</span></span><span class="line"><span class="cl">        //第一步：清空缓存
</span></span><span class="line"><span class="cl">        cleanFilesPath(reinforce_plugin_path + &#34;/.cache&#34;)
</span></span><span class="line"><span class="cl">        cleanFilesPath(reinforce_plugin_path + &#34;/output&#34;)
</span></span><span class="line"><span class="cl">        cleanFilesPath(reinforce_plugin_path + &#34;/jiagu.db&#34;)
</span></span><span class="line"><span class="cl">        cleanFilesPath(reinforce_plugin_path + &#34;/tempAndroidManifest.xml&#34;)
</span></span><span class="line"><span class="cl">        cleanFilesPath(channel_apks_path)
</span></span><span class="line"><span class="cl">        //第二步：开始加固
</span></span><span class="line"><span class="cl">        reinforceApk()
</span></span><span class="line"><span class="cl">        //清除无用缓存
</span></span><span class="line"><span class="cl">        cleanFilesPath(reinforce_plugin_path + &#34;/.cache&#34;)
</span></span><span class="line"><span class="cl">        cleanFilesPath(reinforce_plugin_path + &#34;/output&#34;)
</span></span><span class="line"><span class="cl">        cleanFilesPath(reinforce_plugin_path + &#34;/jiagu.db&#34;)
</span></span><span class="line"><span class="cl">        cleanFilesPath(reinforce_plugin_path + &#34;/tempAndroidManifest.xml&#34;)
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/**
</span></span><span class="line"><span class="cl"> * 注释：使用360加固加固Release包
</span></span><span class="line"><span class="cl"> * 时间：2019/1/2 0002 14:32
</span></span><span class="line"><span class="cl"> * 作者：郭翰林
</span></span><span class="line"><span class="cl"> */
</span></span><span class="line"><span class="cl">def reinforceApk() {
</span></span><span class="line"><span class="cl">    println(&#39;开始进行加固操作&#39;)
</span></span><span class="line"><span class="cl">    File releaseApk = new File(release_apk_path)
</span></span><span class="line"><span class="cl">    if (!releaseApk.exists()) {
</span></span><span class="line"><span class="cl">        throw new FileNotFoundException(&#34;Release包不存在，无法进行加固操作,文件路径：${releaseApk.getAbsolutePath()}&#34;)
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    //创建渠道文件夹
</span></span><span class="line"><span class="cl">    File channelApksPath = new File(channel_apks_path)
</span></span><span class="line"><span class="cl">    if (!channelApksPath.exists()) {
</span></span><span class="line"><span class="cl">        channelApksPath.mkdir()
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    exec {
</span></span><span class="line"><span class="cl">        commandLine &#34;bash&#34;, &#34;-c&#34;, &#34;chmod +x ${reinforce_plugin_path}/java/bin/*&#34;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    exec {
</span></span><span class="line"><span class="cl">        commandLine &#34;bash&#34;, &#34;-c&#34;, &#34;java -jar ${reinforce_plugin_path}/jiagu.jar -login ${reinforce_plugin_name} ${reinforce_plugin_passward}&#34;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    exec {
</span></span><span class="line"><span class="cl">        commandLine &#34;bash&#34;, &#34;-c&#34;, &#34;java -jar ${reinforce_plugin_path}/jiagu.jar -importsign ${key_store_path} ${key_store_passward} ${alias} ${alias_passward}&#34;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    exec {
</span></span><span class="line"><span class="cl">        commandLine &#34;bash&#34;, &#34;-c&#34;, &#34;java -jar ${reinforce_plugin_path}/jiagu.jar -importmulpkg ${chanel_config_path}&#34;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    exec {
</span></span><span class="line"><span class="cl">        commandLine &#34;bash&#34;, &#34;-c&#34;, &#34;java -jar ${reinforce_plugin_path}/jiagu.jar -jiagu ${release_apk_path} ${channel_apks_path} -autosign -automulpkg&#34;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    println(&#39;加固操作结束，加固包路径&#39; + channelApksPath.getAbsolutePath())
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/**
</span></span><span class="line"><span class="cl"> * 注释：清空文件夹
</span></span><span class="line"><span class="cl"> * 时间：2019/1/2 0002 14:15
</span></span><span class="line"><span class="cl"> * 作者：郭翰林
</span></span><span class="line"><span class="cl"> */
</span></span><span class="line"><span class="cl">def cleanFilesPath(String path) {
</span></span><span class="line"><span class="cl">    File files = new File(path)
</span></span><span class="line"><span class="cl">    if (!files.exists()) {
</span></span><span class="line"><span class="cl">        return
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    println(&#39;开始执行清除:&#39; + files.getAbsolutePath())
</span></span><span class="line"><span class="cl">    if (files.isDirectory()) {
</span></span><span class="line"><span class="cl">        String[] content = files.list()//取得当前目录下所有文件和文件夹
</span></span><span class="line"><span class="cl">        for (String name : content) {
</span></span><span class="line"><span class="cl">            File temp = new File(path, name)
</span></span><span class="line"><span class="cl">            if (temp.isDirectory()) {//判断是否是目录
</span></span><span class="line"><span class="cl">                cleanFilesPath(temp.getAbsolutePath())//递归调用，删除目录里的内容
</span></span><span class="line"><span class="cl">                temp.delete()
</span></span><span class="line"><span class="cl">            } else {
</span></span><span class="line"><span class="cl">                temp.delete()
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    files.delete()
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到这里我们使用了360加固来执行加固和打渠道包的操作，那么我们怎么去把360加固引到工程里呢？答案很简单，直接360官网下载，然后直接拉360安装路径的文件夹到工程里。如下图所示：</p>
<p><img src="/images/360_jiagu.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>Android的部分就介绍到这，下面我们来看IOS打包脚本部分，前面说到IOS是通过FastLane去实现打包的，但众所周知，IOS打包需要证书以及签名，这个我们在FastLane脚本里改怎么去配置？</p>
<p>关于Fastlane怎么集成，怎么部署网上都有教程这里不去赘述，这里主要说的就是Fastlane里的脚本该如何去书写，怎么去配置证书以及签名</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># This file contains the fastlane.tools configuration
</span></span><span class="line"><span class="cl"># You can find the documentation at https://docs.fastlane.tools
</span></span><span class="line"><span class="cl">#
</span></span><span class="line"><span class="cl"># For a list of all available actions, check out
</span></span><span class="line"><span class="cl">#
</span></span><span class="line"><span class="cl">#     https://docs.fastlane.tools/actions
</span></span><span class="line"><span class="cl">#
</span></span><span class="line"><span class="cl"># For a list of all available plugins, check out
</span></span><span class="line"><span class="cl">#
</span></span><span class="line"><span class="cl">#     https://docs.fastlane.tools/plugins/available-plugins
</span></span><span class="line"><span class="cl">#
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Uncomment the line if you want fastlane to automatically update itself
</span></span><span class="line"><span class="cl"># update_fastlane
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">default_platform(:ios)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">platform :ios do
</span></span><span class="line"><span class="cl">  desc &#34;build projcet&#34;
</span></span><span class="line"><span class="cl">  #配置Fastlane任务
</span></span><span class="line"><span class="cl">  lane :build do
</span></span><span class="line"><span class="cl">    #配置工程基本信息
</span></span><span class="line"><span class="cl">    update_app_identifier(
</span></span><span class="line"><span class="cl">      xcodeproj: &#34;XYZ_iOS.xcodeproj&#34;, # Optional path to xcodeproj, will use the first .xcodeproj if not set
</span></span><span class="line"><span class="cl">      plist_path: &#34;XYZ_iOS/XYZ_iOS-Info.plist&#34;, # Path to info plist file, relative to xcodeproj
</span></span><span class="line"><span class="cl">      app_identifier: &#34;com.focuschina.xyz&#34; # The App Identifier
</span></span><span class="line"><span class="cl">    )
</span></span><span class="line"><span class="cl">	#配置签名以及证书
</span></span><span class="line"><span class="cl">    automatic_code_signing(
</span></span><span class="line"><span class="cl">      path: &#34;XYZ_iOS.xcodeproj&#34;,
</span></span><span class="line"><span class="cl">	  #启用自动签名
</span></span><span class="line"><span class="cl">      use_automatic_signing: true,
</span></span><span class="line"><span class="cl">      code_sign_identity: &#34;iPhone Developer&#34;,
</span></span><span class="line"><span class="cl">	  #根据证书拿到团队ID或者直接去苹果开发者官方查阅
</span></span><span class="line"><span class="cl">      team_id:&#34;HB2YRTXXXXX&#34;,
</span></span><span class="line"><span class="cl">    )
</span></span><span class="line"><span class="cl">	#配置生成包的类型以及发布渠道
</span></span><span class="line"><span class="cl">    gym(scheme: &#34;XYZ_iOS&#34;,
</span></span><span class="line"><span class="cl">      workspace: &#34;XYZ_iOS.xcworkspace&#34;,
</span></span><span class="line"><span class="cl">      configuration: &#34;Debug&#34;,
</span></span><span class="line"><span class="cl">      clean: true,
</span></span><span class="line"><span class="cl">      output_name:&#34;XYZ_iOS.ipa&#34;,
</span></span><span class="line"><span class="cl">      export_xcargs:&#34;-allowProvisioningUpdates&#34;,
</span></span><span class="line"><span class="cl">      export_method: &#34;development&#34;           # app-store, ad-hoc, package, enterprise, development, developer-id
</span></span><span class="line"><span class="cl">    )
</span></span><span class="line"><span class="cl">  end
</span></span><span class="line"><span class="cl">  lane :build_ts do
</span></span><span class="line"><span class="cl">    update_app_identifier(
</span></span><span class="line"><span class="cl">      xcodeproj: &#34;XYZ_iOS.xcodeproj&#34;, # Optional path to xcodeproj, will use the first .xcodeproj if not set
</span></span><span class="line"><span class="cl">      plist_path: &#34;XYZ_iOS/XYZ_iOS-Info.plist&#34;, # Path to info plist file, relative to xcodeproj
</span></span><span class="line"><span class="cl">      app_identifier: &#34;com.focuschina.xyz&#34; # The App Identifier
</span></span><span class="line"><span class="cl">    )
</span></span><span class="line"><span class="cl">    automatic_code_signing(
</span></span><span class="line"><span class="cl">      path: &#34;XYZ_iOS.xcodeproj&#34;,
</span></span><span class="line"><span class="cl">      use_automatic_signing: true,
</span></span><span class="line"><span class="cl">      code_sign_identity: &#34;iPhone Developer&#34;,
</span></span><span class="line"><span class="cl">      team_id:&#34;HB2YRXXXXXX&#34;,
</span></span><span class="line"><span class="cl">    )
</span></span><span class="line"><span class="cl">    gym(scheme: &#34;XYZ_iOS&#34;,
</span></span><span class="line"><span class="cl">      workspace: &#34;XYZ_iOS.xcworkspace&#34;,
</span></span><span class="line"><span class="cl">      configuration: &#34;Release&#34;,
</span></span><span class="line"><span class="cl">      clean: true,
</span></span><span class="line"><span class="cl">      output_name:&#34;XYZ_iOS.ipa&#34;,
</span></span><span class="line"><span class="cl">      export_xcargs:&#34;-allowProvisioningUpdates&#34;,
</span></span><span class="line"><span class="cl">      export_method: &#34;app-store&#34;           # app-store, ad-hoc, package, enterprise, development, developer-id
</span></span><span class="line"><span class="cl">    )
</span></span><span class="line"><span class="cl">  end
</span></span><span class="line"><span class="cl">  lane :build_number do
</span></span><span class="line"><span class="cl">    increment_build_number(build_number: ENV[&#34;BUILD_VERSION_CODE&#34;])
</span></span><span class="line"><span class="cl">  end
</span></span><span class="line"><span class="cl">  lane :build_version do
</span></span><span class="line"><span class="cl">    increment_version_number
</span></span><span class="line"><span class="cl">  end
</span></span><span class="line"><span class="cl">  lane :upload do
</span></span><span class="line"><span class="cl">    pgyer
</span></span><span class="line"><span class="cl">  end
</span></span><span class="line"><span class="cl">  lane :upload_ts do
</span></span><span class="line"><span class="cl">    upload_to_testflight
</span></span><span class="line"><span class="cl">  end
</span></span><span class="line"><span class="cl">end
</span></span></code></pre></td></tr></table>
</div>
</div><p>从上面可以看到定义了很多<strong>lane: XXX do</strong>,这个就是定义Fastlane的任务的原子操作，翻阅上面Jenkins脚本，最后调用的打包脚本也就是这里的任务。</p>
<h3 id="五jenkins里的任务配置">五、Jenkins里的任务配置</h3>
<p>前面几个章节已经说了怎么去书写Jenkinsfile脚本以及Android、IOS的打包脚本该怎么去写。下面我们来详细说说，怎么把这些部署到Jenkins，变成可视化的配参任务。</p>
<p><strong>第一步</strong>，首先新建一个Item任务，然后选择多分支流水</p>
<p><img src="/images/ci_1.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p><strong>第二步</strong>，配置任务的分支源，以及编译配置</p>
<p><img src="/images/ci_2.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p><img src="/images/ci_3.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>对，这里我们直接填写Jenkinsfile的名称即可，因为我的Jenkins脚本是直接放在工程根目录下的，如果你不是放在根目录，则需要填写正确的层级。</p>
<p><strong>第三步</strong> 点击保存，则可以在Jenkins主面板看到新建的多分支流水任务，第一次运行可能看不到可视化参数配置，需要第二次运行分支脚本才可以看到可视化参数配置。</p>
<p><img src="/images/ci_4.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p><img src="/images/ci_5.webp"
	
	
	
	loading="lazy"
	
	
></p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/devops/">Devops</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/posts/devops/gradle_pgyer/">
        
        

        <div class="article-details">
            <h2 class="article-title">Gradle结合蒲公英做一键上传打包至蒲公英</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/posts/devops/ios_pgyer/">
        
        

        <div class="article-details">
            <h2 class="article-title">IOS 一键打包上传蒲公英脚本</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src="https://utteranc.es/client.js" 
        repo="RmondJone/RmondJone.github.io"
        issue-term="pathname"
        
        label="Comment"
        
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    let utterancesLoaded = false;

    function setUtterancesTheme(theme) {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://utteranc.es'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') return;

        
        utterancesLoaded = true;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        if (!utterancesLoaded) return;
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2023 郭翰林的博客
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.16.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
